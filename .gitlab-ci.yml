# This file controls the GitLab CI pipeline for the `ShellLogger`
# project.  See here for the keyword reference:
# https://docs.gitlab.com/ee/ci/yaml/.


# Set up a global cache to pass information across stages.
cache: &global_cache
  key: "${CI_COMMIT_REF_SLUG}_${CI_COMMIT_SHORT_SHA}"
  paths:
    - shelllogger-env/
  policy: pull-push


# Set up the pipeline stages.
stages:
  - prepare
  - install
  - test
  - documentation
  - deploy
  - finish


# Run this before every job.
before_script:
  - |-
    export LSB_RELEASE=$(which lsb_release)
    if [ -x ${LSB_RELEASE} ]; then
        ${LSB_RELEASE} -a
    fi
  - |-
    if [ -d "shelllogger-env" ]; then
        conda activate $(pwd)/shelllogger-env
    else
        echo "Conda environment 'shelllogger-env' was not found."
        exit 1
    fi
    echo "-----"
    conda list
    echo "-----"


# Run this after every job.
after_script:
  - |-
    if [[ "${CONDA_PREFIX}" == "$(pwd)/shelllogger-env" ]]; then
        conda deactivate
    fi


#-----------------------------------------------------------------------
# Stage:  Prepare
#-----------------------------------------------------------------------


# Create the virtual environment, install the requirements, and save the
# environment to the cache.
requirements:
  before_script:
    - conda create --prefix ./shelllogger-env --yes python=3.7 pip
  cache:
    <<: *global_cache
    when: on_success
  script:

    # Activate the virtual environment.
    - conda activate $(pwd)/shelllogger-env

    # Show the contents of the virtual environment.
    - conda list

    # Install required packages.
    - pip install
      -r requirements.txt
      -r tests/requirements.txt
      -r doc/requirements.txt

    # Show the contents of the virtual environment.
    - conda list
  stage: prepare
  timeout: 10m


#-----------------------------------------------------------------------
# Stage:  Install
#-----------------------------------------------------------------------


# Test building a distribution.
wheel:
  artifacts:
    name: "shelllogger-dist"
    paths:
      - dist/shelllogger*.whl
    expire_in: 6 weeks
  cache:
    <<: *global_cache
    policy: pull
  script:
    - pip wheel --no-deps -w dist .
  stage: install
  timeout: 5m


# Test installation of the package.
install:
  cache:
    <<: *global_cache
  script:

    # Install the package.
    - pip install .

    # Show the contents of the virtual environment to ensure it's there.
    - conda list
  stage: install
  timeout: 5m


#-----------------------------------------------------------------------
# Stage:  Test
#-----------------------------------------------------------------------


# Ensure the examples run without problems.
examples:
  artifacts:
    paths:
      - examples/log*
      - examples/*.html
  cache:
    <<: *global_cache
    policy: pull
  script:
    - cd examples
    - python3 ./hello_world_html.py
    - cp -L log_hello_world_html/Hello_World_HTML.html .
    - python3 ./hello_world_html_and_console.py
    - cp -L log_hello_world_html_and_console/Hello_World_HTML_and_Console.html
      .
    - python3 ./hello_world_html_with_stats.py
    - cp -L log_hello_world_html_with_stats/Hello_World_HTML_with_Stats.html .
    - python3 ./build_flex.py
    - cp -L log_build_flex/Build_Flex.html .
  stage: test
  timeout: 5m


# Ensure we pass the `flake8` linter.
flake8:
  cache:
    <<: *global_cache
  script:
    - python3 -m flake8
      --exclude=shelllogger-env
  stage: test
  timeout: 5m


# Execute the unit tests.
pytest:
  artifacts:
    paths:
      - tests/htmlcov
    reports:
      coverage_report:
        coverage_format: cobertura
        path: tests/coverage.xml
      junit: tests/coverage.xml
  cache:
    <<: *global_cache
  coverage: '/TOTAL\s*[0-9]*\s*[0-9]*\s*[0-9]*\s*[0-9]*\s*(\d+%)/'
  script:
    - python3 -m pytest
      --cov=src.shelllogger
      --cov-config=.coveragerc
      --cov-report=html
      --cov-report=term
      --cov-report=xml
      --full-trace
      tests/
  stage: test
  timeout: 5m


# Ensure we adhere to our style guide.variables:
yapf:
  artifacts:
    expire_in: 1 week
    paths:
      - yapf.diff.txt
    when: on_failure
  cache:
    <<: *global_cache
  script:
    - set +e
    - python3 -m yapf
      --style .style.yapf
      --diff
      --recursive
      examples/
      src/
      tests/
      > yapf.diff.txt
    - |-
      if [[ "$(wc -l yapf.diff.txt | awk '{print $1}')" != "0" ]]; then
        echo "----------"
        echo "Your code does not match our Python style guide."
        echo -n "Run 'yapf --style .style.yapf --in-place --recursive "
        echo "examples/ src/ tests/' in the repository root to fix it."
        echo "The offending files are:"
        grep "^+++.*(reformatted)$" yapf.diff.txt | awk '{print $2}'
        exit 1
      fi
  stage: test
  timeout: 5m


#-----------------------------------------------------------------------
# Stage:  Documentation
#-----------------------------------------------------------------------


# Generate the documentation.
sphinx:
  artifacts:
    paths:
      - doc/html
  cache:
    <<: *global_cache
  script:
    - cd doc
    - bash make_html_docs.sh
  stage: documentation
  timeout: 5m


#-----------------------------------------------------------------------
# Stage:  Deploy
#-----------------------------------------------------------------------


# Publish coverage data and documentation (if on the main branch).
pages:
  artifacts:
    paths:
      - public
  cache:
    <<: *global_cache
    policy: pull
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
  script:
    - mkdir -p public/examples
    - mv tests/htmlcov public/.
    - mv doc/html/* public/.
    - mv examples/*.html public/examples/.
  stage: deploy
  timeout: 5m


#-----------------------------------------------------------------------
# Stage:  Finish
#-----------------------------------------------------------------------


# Test that uninstalling from a virtual environment works.
uninstall:
  cache:
    <<: *global_cache
  script:
    - pip uninstall -y shelllogger

    # Show the contents of the virtual environment.
    - conda list
  stage: finish
  timeout: 5m
